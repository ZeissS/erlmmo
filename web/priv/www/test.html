<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" 
                    "http://www.w3.org/TR/html4/loose.dtd">
<html>
<head>
  <script src="js/jquery-1.4.2.js"></script>
  <script src="js/erlmmo-api.js"></script>
  <script src="js/qunit.js"></script>
  <link rel="stylesheet" href="js/qunit.css" type="text/css" media="screen" />
  
  <script>
  $(document).ready(function(){
        module("Authentication");
        
        test("login + logoff", function() {
            expect(3);
            stop(10000);
            
            // Login :)
            auth_login("Test1", "a", function(sessionkey) {
              ok(sessionkey != null, "Sessionkey test");
              
              // Now logout again
              auth_logout(sessionkey, function(result) {
                equals(result, "OK", "Check for successfull logout.");
                
                auth_logout(sessionkey, function(result) {
                    
                    same(result, {'type':'error', 'code': 001, "message":"Invalid sessionkey."}, "Invalid session error");
                    
                    start();    
                });
                
              });
            });
        });
        
        
        
        test("Login + Relogin", function() {
           expect(2);
           
           stop(6000);
           
           auth_login("Test2", "password", function(sessionkey) {
                ok(sessionkey != null, "Received sessionkey");
                
                auth_login("Test2", "password", function(sessionkey2, timeout2) {
                   ok(sessionkey2 != sessionkey, "Checking for different sessionkeys.");
                   
                   auth_logout(sessionkey2, function() {
                        start();
                   });
                });
           });
        });
        
        
        module("Chat");
        test("sending and receiving messages", function() {
            expect(6);
            stop(6000);
            
            auth_login("Chat-Test", "mypassword$", function(sessionkey) {
                ok(sessionkey != null, "Successfull login");
                
                event_get(sessionkey, function(events) {
                    ok(events != null, "Valid event received.");
                    
                    equals(events.length, 1, "Receiving one event");
                    
                    
                    same(events[0], {'type':"chat_join_self", 'name':"Global", 'players': ['Chat-Test']}, "Receive self-join message");
                    
                    chat_send(sessionkey, "Global", "QUnit Test-Message", function(result) {
                        equals(result, "OK");
                       
                        event_get(sessionkey, function(events) {
                           
                           same(events, [{'type':"chat_send", 'name':'Global', 'player':"Chat-Test", 'message':"QUnit Test-Message"}], "Receive our own chat message");
                           
                           auth_logout(sessionkey);
                           
                           start();
                        });
                    });
                });
                
            });
        });
        
        
        test("Muti session chat test", function() {
            expect(5);
            stop(1000); 
            
            auth_login("Multi-Chat1", "mypassword1", function(sessionkey1, timeout1){
                ok(sessionkey1 != null, "Successfull login with session 1");
                
                auth_login("Multi-Chat2", "mypassword2", function(sessionkey2, timeout2) {
                    ok(sessionkey2 != null, "Successfull login with session 2");
                    
                    chat_send(sessionkey1, "Global", "QUnit Test-Message #1", function(result) {
                        equals(result, "OK");
                        
                        event_get(sessionkey2, function(result) {
                            same(
                                result,
                                [
                                    { 'type': 'chat_join_self',
                                      'name': 'Global',
                                      'players': ['Multi-Chat1', 'Multi-Chat2']
                                    },
                                    { 'type': 'chat_send',
                                      'name':"Global",
                                      'player': 'Multi-Chat1',
                                      'message': "QUnit Test-Message #1"
                                    }
                                ],
                                "Receiving initial events"                                  
                            );
                            
                            auth_logout(sessionkey1, function() {
                                auth_logout(sessionkey2, function() {
                                    
                                    
                                    chat_get_all_channels(function(channels) {
                                      same(channels, ["Global"], "Checking get channels");
                                      start();
                                    });
                                });
                            });
                            
                            
                        });
                    });
                });
                
            });
            
        });
  });
  </script>
  
</head>
<body>
  <h1 id="qunit-header">ERLMMMO API Tests</h1>
 <h2 id="qunit-banner"></h2>
 <h2 id="qunit-userAgent"></h2>
 <ol id="qunit-tests"></ol>
</body>
</html>
