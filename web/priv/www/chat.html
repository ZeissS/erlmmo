<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
    <title>My Chat</title>
    
    <link type="text/css" href="css/ui-lightness/jquery-ui-1.8.custom.css" rel="stylesheet" />
    <script src="js/jquery-1.4.2.js"></script>
    <script src="js/jquery-ui-1.8.custom.min.js"></script>
    <script src="js/erlmmo-api.js"></script>
    
    <script>
      MODEL = {
	'sessionkey': false,
	
	'init': function() {
	  setInterval(function() { MODEL.handle_events(); }, 1000);
	},
	
	'login': function(username, password) {
	  auth_login(username, password, function(sessionkey) {
	    MODEL.setSessionkey(sessionkey);
	  });
	},
	
	'setSessionkey': function(sessionkey) {
	  MODEL.sessionkey = sessionkey;	  
	},
	
	
	'handle_events': function() {
	  
	  if ( MODEL.sessionkey == false)
	    return;
	  
	  event_get(MODEL.sessionkey, function(events) {
	    for(event in events) {
	      UI.handle_event(events[event]);
	    }
	  });
	}
      };
      
      UI = {
	'init': function() {
	  MODEL.init();  
	  
	  // Register AJAX Error Handler
	  $('body').ajaxError(function(event, xml, options, error) {
	    UI.logError({
	      'event': event,
	      'options': options,
	      'error': error
	    });
	    MODEL.setSessionkey(false); // We kill ourself
	  });
	  
	  $('#chat_window').dialog({
	    'title': 'Chat',
	    'minHeight': 300,
	    'minWidth': 400
	  });
	},
	
	'logError': function(Error) {
	  alert("Error: " + Error.error);
	},
	
	'handle_event': function(event) {
	  
	  if ( event.type == "chat_join_self") {
	    $("#chat_messages").append("<div>You joined <span style='font-weight:bold'>" + event.name + "</span></div>" );
	  } else if ( event.type == "chat_join") {
	    $("#chat_messages").append("<div>" + event.player + " joined <span style='font-weight:bold'>" + event.name + "</span></div>" );
	  } else if ( event.type == "chat_part") {
	    $("#chat_messages").append("<div>" + event.player + " left <span style='font-weight:bold'>" + event.name + "</span></div>" );
	  } else if ( event.type == "chat_send") {
	    $("#chat_messages").append("<div>[" + event.name + "] <b>" + event.player + "</b>: " + event.message + "</div>" );
	  } else {
	    alert("Unknown Eventtype: " + event.type);  
	  }
	}
	
	
      };
      
      function sendChatMessage() {
	if ( !MODEL.sessionkey)
	{
	  alert("Not logged in yet!");
	  return false;
	}
	try {
	  Text = $('#chat_input').val();
	  chat_send(MODEL.sessionkey, "Global", Text);
	  $('#chat_input').val('');
	} catch (E) {
	  UI.logError(E);
	}
	
	return false;
      }
      
      $(document).ready(function() {
	  $("#chat_window").submit(sendChatMessage);
	  
	  $("#window_pane .window .titlebar").bind('click', function(event) {
	    
	  });
	  
	  UI.init();
	  
	  $('#login_dialog').dialog({
	    'modal':true,
	    'closeOnEscape': false,
	    'draggable': false,
	    'title': 'Login',
	    'buttons': {
	      'Login': function() {
		MODEL.login($("#username").val(), $("#password").val());
		$("#login_dialog").dialog('destroy');
	      }
	    },
	    
	    'beforeclose':function(event, ui) {
	      return MODEL.sessionkey != false;
	      
	    }
	  });
      });
    </script>
    <style>
    	#chat_window {
    	  position:relative;
	  border:2px blue solid;
	  margin:0px;
	  padding:0px;
    	}
	#chat_window .channels {
	  position:relative;
	  top:0px;
	  left:0px;
	  right:0px;
	  height:30px;
	  border:1px blue dashed;
	}
	#chat_window .channels ul {
	  display:inline;
	  margin: 0;
	  padding: 0;
	  cursor: default;
	  list-style-type: none;
	  float:left;
	}
	#chat_window .channels ul li {
	  border:1px black solid;
	}
	
    	#chat_window #chat_messages {
	  background-color:yellow;
	  color:black;
	  overflow:auto;
	  
	  position:absolute;
	  
	  top:30px;
	  right:0px;
	  left:0px;
	  bottom:35px;
    	}
	#chat_window #chat_user {
	  padding:3px;
	  position:absolute;
	  bottom:0px;
	  height:30px;
	}
	
	/** ================================================================ */
	
	#navbar {
	  top:0px;
	  left:0px;
	  right:0px;
	  height:30px;
	  color:white;
	}
	
	
	#window_pane {
	  top:35px;
	  left:0px;
	  bottom:0px;
	  right:0px;
	  position:absolute;
	  background-color:gray;
	  z-index:255;
	}
	
    </style>	
  </head>
  <body>
    <div id="navbar">
      <a href="test.html">Tests</a>
    </div>
    
    
    <div id="window_pane">
      
	
      
      <div id="chat_window">
	    <div class="channels">
	      <ul>
		<li>Global</li>
	      </ul>
	    </div>
	    <div id="chat_messages">
	      INITIAL CONTENT
	    </div>
	    <div id="chat_user">
		<form action="#" id="chatform">
		    <input type="text" id="chat_input" size="20" />
		    <input id="chat_submit" type="submit" value="Send" />
		</form>
	    </div>
	</div>
	
	<div id="login_dialog" style="display:hidden">
	  <table>
	    <tr>
	      <td>Login:</td>
	      <td><input id="username" /></td>
	    </tr>
	    <tr>
	      <td>Password:</td>
	      <td><input id="password" type="password" /></td>
	    </tr>
	  </table>
	</div>
      
      </div>
    
    
  </body>
</html>
