<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/> 
    <title>ErlMMO</title>
    
    <link type="text/css" href="css/ui-lightness/jquery-ui-1.8.custom.css" rel="stylesheet" />
    <script src="js/jquery-1.4.2.js"></script>
    <script src="js/jquery-ui-1.8.custom.min.js"></script>
    <script src="js/erlmmo-api.js"></script>
    
    <script>
      function chat_model() {
	model = {
	  'listeners': [],
	  
	  'channels': [],
	  /*
	  channel: {
	    'name': 'NAME',
	    'sessions': [
	      {'name':'NAME', 'gravatar_id':'GRAVATAR'}
	      
	    ],
	    'messages': [
	      ?MESSAGE_EVENT
	    ]
	  }
	  */
	  
	  'init': function() {
	    MODEL.listeners.push(this);
	  },
	  
	  'handleEvent': function(event) {
	      if ( event.type == "chat_join_self") {
		this.newChannel(event);
	      } else if ( event.type == "chat_join") {
		this.addChannelPlayer(
		  event.name,
		  event.player
		);
	      } else if ( event.type == "chat_part_self") {
		this.deleteChannel(event.name);
	      } else if ( event.type == "chat_part") {
		this.removeChannelPlayer(event.name, event.player);
	      } else if ( event.type == "chat_send") {
		this.addChannelMessage(event.name, event.player, event.message);
	      } else {
		return false;
	      }
	      return true;
	    },
	    
	    'fireEvent': function(event_object) {
	      for ( x in this.listeners ) {
		lst = this.listeners[x];
		lst(event_object);
	      }
	    },
	    
	    'newChannel': function(Channel) {
	      this.channels[Channel.name] = {
		'name': Channel.name,
		'messages': [],
		'players': Channel.players
	      };
	      this.fireEvent(['chat_join', Channel.name]);
	    },
	    
	    'deleteChannel': function(ChannelName) {
	      delete(this.channels[ChannelName]);
	      this.fireEvent(['chat_part', ChannelName]);
	    },
	    
	    'addChannelPlayer': function(ChannelName, Player) {
	      this.channels[ChannelName].players.push(Player);
	      this.fireEvent(['players_changed', ChannelName]);
	    },
	    
	    'removeChannelPlayer': function(ChannelName, Player) {
	      Players = this.channels[ChannelName].players.filter(function(x) {
		return x != Player;
	      });
	      this.channels[ChannelName].players = Players;
	      this.fireEvent(['players_changed', ChannelName]);
	    },
	    
	    'addChannelMessage': function(ChannelName, Player, Message) {
	      if ( this.channels[ChannelName] ) {
		this.channels[ChannelName].messages.push({
		  'player': Player,
		  'message': Message
		});
		this.fireEvent(['chat_send', ChannelName]);
	      }
	    },
	    
	    
	    'partChannel': function(Channel) {
	      chat_part(MODEL.sessionkey, Channel);
	    }
	    
	};
	return model;
      }
      
      
      function chat_ui() {
	return {
	  'model': chat_model(),
	  'currentChannel': false,
	  
	  'init': function() {
	    this.model.init();
	    
	    this.model.listeners.push(function(event) {
	      UI.CHAT.handleChatModelEvent(event);
	    });
	    
	    
	    var chat = $('#chat_window').dialog({
	      'title': 'Chat',
	      'minHeight': 300,
	      'height': 300,
	      'minWidth': 400,
	      'width': 490
	    });
	    chat.parent().css("top", "");
	    chat.parent().css("bottom", "20px");
	    chat.parent().css("left", "20px");
	    
	    // The "Say" button
	    $("#chat_window").submit(this.eventSendMessage);
	    
	    $("#chat_part").click(function() {
	      UI.CHAT.model.partChannel(UI.CHAT.currentChannel);
	    });
	    
	    // $('#chat_window .channels ul li').bind('click', this.eventTabClickHandler);
	  },
	  
	  'selectChannel': function(ChannelName) {
	    // Channel exists
	    if ( this.model.channels[ChannelName])
	    {
	      this.currentChannel = ChannelName;
	      this.renderPlayerList(ChannelName);
	      this.renderChatMessages(ChannelName);
	      this.renderSelectedChannelTab();
	    }
	  }, // selectChannel
	  
	  'eventSendMessage': function() {
	    if ( !MODEL.sessionkey || !UI.CHAT.currentChannel)
	    {
	      alert("Not logged in yet!");
	      return false;
	    }
	    try {
	      var Text = $('#chat_input').val();
	      chat_send(MODEL.sessionkey, UI.CHAT.currentChannel, Text);
	      $('#chat_input').val('');
	    } catch (E) {
	      UI.logError(E);
	    }
	    return false;
	  },
	  
	  'handleChatModelEvent': function(event) {
	    if ( event[0] == "chat_join") {
	      this.renderChannelTabs();
	      if ( this.currentChannel == false) {
		this.selectChannel(event[1]);
	      }
	    }
	    else if ( event[0] == "chat_part") {
	      this.renderChannelTabs();
	      
	      if ( event[1] == this.currentChannel) {
		for ( x in this.model.channels ) {
		  this.selectChannel(x);
		  return; // simply the select the first channel
		}
		
	      }
	    }
	    else if ( event[0] == 'players_changed')
	    {
	      if ( event[1] == this.currentChannel ) {
		// The players list has been updated
		this.renderPlayerList(event[1]);
	      } else {
		// we do not look at this channel currently, so we don't care
	      }
	    } else if ( event[0] == "chat_send") {
	      if ( this.currentChannel == event[1]) {
		this.renderChatMessages(event[1]);
	      }
	    } else {
	      $("#chat_messages").append("<div>Unknown chat model event: " + event[0] + "</div>");  
	    }
	  },
	  
	  'renderChatMessages': function(ChannelName) {
	    var div = $("#chat_messages");
	    div.html('');
	    for ( x in this.model.channels[ChannelName].messages) {
	      var msg = this.model.channels[ChannelName].messages[x];
	      div.append("<div><b>" + msg.player + "</b>: " + msg.message + "</div>" );
	    }
	    
	  },
	  
	  'renderSelectedChannelTab': function() {
	    var ChannelName = this.currentChannel;
	    var ul = $("#chat_window .channels ul li");
	    ul.each(function() {
	      if ( $(this).text() == ChannelName) {
		$(this).addClass("selected");
	      } else {
		$(this).removeClass("selected");
	      }
	    });
	  },
	  
	  'renderChannelTabs': function() {
	    var ul = $("#chat_window .channels ul");
	    ul.html('');
	    for ( name in this.model.channels) {
	      ul.append("<li>" + name + "</li>");
	    }
	    this.renderSelectedChannelTab();
	    
	    $("#chat_window .channels ul li").click(function() {
	      UI.CHAT.selectChannel($(this).text());
	    });
	  },
	  
	  'renderPlayerList': function(ChannelName) {
	    var Channel = this.model.channels[ChannelName];
	    
	    var ul = $("#chat_window .channel_sessions ul");
	    ul.html(''); // Clear
	    for( x in Channel.players)
	    {
	      ul.append('<li>' + Channel.players[x] + '</li>');
	    }
	  },
	  
	  'show': function() {
	    $("#chat_window").dialog('open');
	  }
	};
      }
      
      function system_log_model() {
	model = {
	  'messages': [],
	  'listeners': [],
	  
	  'addListener': function(listener) {
	    this.listeners.push(listener);
	  },
	  
	  'addMessage':function(message) {
	    this.messages.push(message);
	  },
	  
	  'fireEvent': function(event) {
	    for ( x in this.listeners) {
	      this.listeners[x].handleEvent(event);
	    }
	  },
	  
	  'handleEvent': function(event) {
	    this.messages.push(event);
	    this.fireEvent(['new_event']);
	  }
	};
	return model;
      }
      
      function system_log_ui() {
	return {
	  'model': system_log_model(),
	  
	  'init': function() {
	    this.model.addListener(this);
	    
	    var log = $("#system_log_ui").dialog({
	      'title': 'System Log',
	      'minWidth': 400,
	      'minHeight': 300,
	      'height': 300,
	      'width': 400
	    });
	    log.parent().css("top", "");
	    log.parent().css("bottom", "20px");
	    log.parent().css("left", "");
	    log.parent().css("right", "20px");
	  },
	  
	  
	  'renderMessages': function() {
	    div = $("#system_log_ui").html('');
	    for ( x in this.model.messages) {
	      var msg = this.model.messages[x];
	      
	      if ( typeof(msg)  == "string") {
		div.append('<div>' + msg + '</div>');
	      } else if ( msg.type == "error") {
		div.append('<div>ERROR: ' + msg.message + '(' + msg.code + ')</div>');
	      } else {
		div.append('<div>Unknown event: ' + msg.type + '</div>');
	      }
	    }
	  },
	  
	  'handleEvent': function(event) {
	    this.renderMessages();
	  }
	};
      }
      
      
      function zone_model() {
	model = {
	  // Where is the ship currently?
	  'coordinates': false,
	  
	  // Who am I? :)
	  'selfObject': false,
	  
	  'listeners': [],
	  'objects': [],
	  
	  'handleEvent': function(event) {
	    if ( event.type == "zone_status" ) {
	      this.selfObject = event.self;
	      
	      this.updateObjects(event.objects);
	      return true;
	    }
	    return false;
	  },
	  
	  'updateObjects': function(objects) {
	    this.objects = [];
	    
	    for ( x in objects ) {
	      var obj = objects[x];
	      // each obj: {coord: {x:0, y:1}, player:'Miro'}
	      this.objects.push(obj);  
	    }
	    this.fireEvent(['objects_updated']);
	  },
	  
	  'fireEvent': function(event) {
	    for ( x in this.listeners) {
	      this.listeners[x].handleEvent(event);
	    }
	  }
	  
	};
	MODEL.listeners.push(model);
	return model;
      };
      
      function zone_ui () {
	return {
	  'model': zone_model(),
	  'context': false,
	  
	  'visibleFieldsHorizontal': 11,
	  'visibleFieldsVertical': 7,
	  
	  'fieldRenderWidth' : 100,
	  'fieldRenderHeight':  100,
	  
	  'init': function() {
	    this.model.listeners.push(this);
	    this.context = document.getElementById("zone_ui_canvas").getContext("2d");
	    this.context.canvas.width = this.visibleFieldsHorizontal * this.fieldRenderWidth;
	    this.context.canvas.height = this.visibleFieldsVertical * this.fieldRenderHeight;
	    
	    var list = $("#zone_list").dialog({
	      'title':'Zone Objects',
	      'width': 250,
	      'height': 550
	    });
	    list.parent().css("top", "60px");
	    list.parent().css("left", "");
	    list.parent().css("right", "20px");
	    
	    $("#zone_ui_canvas").click(this.event_click)
			        .mousemove(this.event_mousemove);
		    
	    
	    this.redraw();
	  },
	  'event_click': function(event) {
	    
	  },
	  
	  'event_mousemove': function(event) {
	    UI.ZONE.x = event.clientX;
	    UI.ZONE.y = event.clientY;
	  },
	  
	  'handleEvent': function(event) {
	    if ( event[0] == "objects_updated") {
	      this.renderObjectList();
	      this.redraw();
	    }
	  },
	  
	  /**
	   * Translate a game x,y coordinate into the upper left point of the field on the canvas
	   *
	   * Returns: [canvas_x, canvas_y]
	   */
	  'coordinates2point': function(x,y) {
	    if ( !this.model.selfObject ) {
	      return [x,y];
	    }
	    
	    var posX = Math.floor(this.visibleFieldsHorizontal / 2); // 5
	    var posY = Math.floor(this.visibleFieldsVertical / 2); // 4
	    
	    var coords = this.model.selfObject.coord;
	    
	    var tmpX = (posX + (x - coords.x)) * this.fieldRenderWidth;
	    var tmpY = (posY + (y - coords.y)) * this.fieldRenderHeight;
	    return [ tmpX, tmpY ];
	  },
	  
	  'renderObjectList': function() {
	    var ul = $("#zone_list ul").html('');
	    for ( x in this.model.objects) {
	      var obj = this.model.objects[x];
	      
	      ul.append('<li>' + obj.name + ' (' + obj.prototype.name + ') [' + obj.coord.x + ', ' + obj.coord.y + ']</li>');
	    }
	  },

	  // Use the this.context to 'draw' the known objects on to the 'background' of the UI
	  'redraw': function() {
	    var ctx = this.context;
	    ctx.save();
	    var w = ctx.canvas.width;
	    var h = ctx.canvas.height;
	    ctx.clearRect(0,0, w, h);
	    
	    this.renderZoneGrid(ctx);
	    this.renderZoneObjects(ctx);
	    this.renderZoneMouse(ctx);
	    ctx.restore();
	  },
	  
	  
	  'renderZoneMouse': function(ctx) {
	    ctx.save();
	    
	    ctx.beginPath();
	    ctx.arc(this.x, this.y, 80, 0, 360, false);
	    ctx.fill();
	    
	    
	    ctx.restore();
	  },
	  
	  'renderZoneGrid': function(ctx) {
	    ctx.save();
	    
	    for ( x = 0; x <= ctx.canvas.width; x += this.fieldRenderWidth) {
	      for ( y = 0; y <= ctx.canvas.height; y+= this.fieldRenderHeight) {
		ctx.strokeRect(x,y, this.fieldRenderWidth, this.fieldRenderHeight);
		
	      }
	    }
	    
	    ctx.restore();
	  },
	  
	  'renderZoneObjects': function(ctx) {
	    ctx.save();
	    
	    for ( x in this.model.objects ) {
	      var object = this.model.objects[x];
	      var Coord = this.coordinates2point(object.coord.x, object.coord.y);
	      
	      ctx.beginPath();
	      
	      switch ( object.prototype.size )
	      {
		case 1:
		    ctx.moveTo(5 + Coord[0], 5 + Coord[1]);
		    ctx.lineTo(-5 + Coord[0] + this.fieldRenderWidth,
			       -5 + Coord[1] + this.fieldRenderHeight);
		    
		    ctx.moveTo(Coord[0] + this.fieldRenderWidth - 5, 5 + Coord[1]);
		    ctx.lineTo(Coord[0] + 5, Coord[1] + this.fieldRenderHeight - 5);
		    ctx.stroke();
		    break;
		default:
		    var x = Coord[0] + this.fieldRenderWidth / 2;
		    var y = Coord[1] + this.fieldRenderHeight / 2;
		    
		    var range = this.fieldRenderWidth / 2 + (this.fieldRenderWidth * (object.prototype.size -1))
		    
		    ctx.arc (
			  x,
			  y,
			  range,
			  0,
			  360,
			  false);
		    ctx.fill();
		    break;
	      }
	      ctx.closePath();
	      
	    }
	    
	    
	    ctx.restore();
	  }
	};
      }
      
      
      
    
      MODEL = {
	'sessionkey': false,
	'listeners': [],
	
	'init': function() {
	  setInterval(function() { MODEL.handle_events(); }, 1000);
	},
	
	'login': function(username, password) {
	  auth_login(username, password, function(sessionkey) {
	    MODEL.setSessionkey(sessionkey);
	  });
	},
	
	'logout': function() {
	  auth_logout(this.sessionkey);
	  this.sessionkey = false; // we kill the sessionkey directly, so no one can accicidently contiue to use it.
	},
	
	'setSessionkey': function(sessionkey) {
	  MODEL.sessionkey = sessionkey;	  
	},
	
	
	'handle_events': function() {
	  
	  if ( MODEL.sessionkey == false)
	    return;
	  
	  
	  event_get(MODEL.sessionkey, function(events) {
	    for(event in events) {
	      MODEL.handleEvent(events[event]);
	    }
	  });
	},
	
	'handleEvent': function(event) {
	  var handled = false;
	  for ( x in this.listeners ) {
	    if ( this.listeners[x].handleEvent(event) ) {
	      handled = true;
	    }
	  }
	  
	  if ( !handled ) {
	    UI.SYSTEM_LOG.model.handleEvent(event);
	  }
	  
	}
      };
      
      UI = {
	'CHAT': chat_ui(),
	'SYSTEM_LOG': system_log_ui(),
	'ZONE': zone_ui(),
	
	'init': function() {
	  MODEL.init();  
	  
	  // Register AJAX Error Handler
	  $('body').ajaxError(function(event, xml, options, error) {
	    UI.logError({
	      'event': event,
	      'options': options,
	      'error': error
	    });
	    MODEL.setSessionkey(false); // We kill ourself
	  });
	  
	  this.CHAT.init();
	  this.SYSTEM_LOG.init();
	  this.ZONE.init();
	},
	
	'logout': function() {
	  if ( MODEL.sessionkey ) {
	    MODEL.logout();  
	  }
	  UI.showLoginDialog();
	},
	
	'logError': function(Error) {
	  alert("Error: " + Error.error);
	},
	
	
	'input': function(parameters) {
	  
	  $("#ui_input").dialog({
	    'modal': true,
	    'closeOnEscape': true,
	    'title': parameters.message,
	    'buttons': {
	      'OK': function() {
		parameters.callback($("#ui_input input.answer").val());
		$("#ui_input").dialog('destroy');
	      }
	    }
	  });
	},
	
	'showLoginDialog': function() {
	  // Reset the password field
	  $("#password").val('');
	  
	  $('#login_dialog').dialog({
	    'modal':true,
	    'closeOnEscape': false,
	    'draggable': false,
	    'title': 'Login',
	    'buttons': {
	      'Login': function() {
		MODEL.login($("#username").val(), $("#password").val());
		$("#login_dialog").dialog('destroy');
	      }
	    },
	    
	    'beforeclose':function(event, ui) {
	      return MODEL.sessionkey != false;
	    }
	  });
	  
	},
	
	'showChatChannelDialog': function() {
	  var chat = $("#chat_channels_dialog").dialog({
	    'closeOnEscape': true,
	    'draggable': true,
	    'title': 'Channels',
	    'buttons': {
	      'New': function() {
		UI.input({
		  'message': 'Enter the name of the new channel:',
		  'callback': function(input_text) {
		    chat_join(MODEL.sessionkey, input_text);
		    $("#chat_channels_dialog").dialog('destroy');
		  }
		});
	      }
	    }
	  });
	  
	  $("#chat_channels_dialog ul").html("<li>Loading ...</li>");
	  
	  chat_get_all_channels(function(channels) {
	    ul = $("#chat_channels_dialog ul");
	    ul.html('');
	    
	    for (x in channels) {
	      ul.append('<li>' + channels[x] + '</li>');
	    }
	  });
	}
	
	
      };
      
      $(document).ready(function() {
	  UI.init();
	  
	  UI.showLoginDialog();
      });
    </script>
    <style>
    	#chat_window {
    	  position:relative;
	  margin:0px;
	  padding:0px;
    	}
	#chat_window .channels {
	  position:relative;
	  top:0px;
	  left:0px;
	  right:0px;
	  height:30px;
	  
	  padding-left:5px;
	  padding-top:3px;
	  
	  
	}
	#chat_window .channels ul {
	  margin: 0;
	  padding: 2px;
	  cursor: default;
	  list-style-type: none;
	}
	#chat_window .channels ul li {
	  margin-left:3px;
	  margin-right:3px;
	  margin-top:2px;
	  padding:3px;
	  display:inline;
	  /*
	  border-top:1px black solid;
	  border-right:1px black solid;
	  border-left:1px black solid;
	  */
	}
	#chat_window .channels ul li.selected {
	  text-decoration:underline;
	  text-weight:bold;
	}
	
	#chat_window .channel_sessions {
	  overflow: scroll;
	  
	  position:absolute;
	  top:30px;
	  right:0px;
	  width:150px;
	  bottom:35px;
	  
	}
    	#chat_window #chat_messages {
	  overflow:scroll;
	  padding:3px;
	  
	  position:absolute;
	  
	  top:30px;
	  right:150px;
	  left:0px;
	  bottom:35px;
    	}
	
	#chat_window #chat_user {
	  padding:3px;
	  position:absolute;
	  left:0px;
	  right:0px;
	  bottom:0px;
	  height:30px;
	}
	
	/** ================================================================ */
	
	#navbar {
	  top:0px;
	  left:0px;
	  right:0px;
	  height:30px;
	  color:white;
	}
	
	
	#window_pane {
	  top:35px;
	  left:0px;
	  bottom:0px;
	  right:0px;
	  position:absolute;
	  background-color:gray;
	  z-index:255;
	}
	
    </style>	
  </head>
  <body>
    <div id="navbar">
      <a href="test.html">Tests</a>
      <span style="float:right">
	<a href="javascript:UI.CHAT.show()">Chat</a>
	<a href="javascript:UI.showChatChannelDialog()">Channels</a>
	<a href="javascript:UI.logout()">Logout</a>
      </span>
    </div>
    
    
    <div id="window_pane">
      <canvas id="zone_ui_canvas" style="width:100%; height:100%"></canvas>
    </div>
  
    <div id="chat_window">
	  <div class="channels">
	    <ul></ul>
	  </div>
	  <div id="chat_messages">
	  </div>
	  <div class="channel_sessions">
	    <ul></ul>
	  </div>
	  <div id="chat_user">
	      <form action="#" id="chatform">
		<input type="text" id="chat_input" size="32" />
		<input id="chat_submit" type="submit" value="Send" />
		<input id="chat_part" type="button" value="Part" />
	      </form>
	  </div>
      </div>
      
      <div id="login_dialog" style="display:hidden">
	<table>
	  <tr>
	    <td>Login:</td>
	    <td><input id="username" /></td>
	  </tr>
	  <tr>
	    <td>Password:</td>
	    <td><input id="password" type="password" /></td>
	  </tr>
	</table>
      </div>
      
      <div id="system_log_ui" style="display:hidden; overflow:auto">
	
      </div>
      
      <div id="zone_list" style="display:hidden">
	<ul>
	  
	</ul>
      </div>
      
      <div id="chat_channels_dialog" style="display:hidden">
	<div>Select your channel:</div>
	<ul>
	</ul>
      </div>
      
      
      <div id="ui_input" style="display:hidden">
	  <div class="message">Question</div>
	  <div><input class="answer" /></div>
      </div>
    
  </body>
</html>
